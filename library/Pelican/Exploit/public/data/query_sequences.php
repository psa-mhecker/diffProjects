<?php
/**
	* @package Pelican
	* @subpackage Db
	*/

include_once('config.php');

if (!$_SESSION[APP]["user"]["id"]) {
	echo("Veuillez vous identifier en Back Office");
	exit;
}

$oConnection = Pelican_Db::getInstance();
$oConnection->setExitOnError(false);

$seq = "select * from user_sequences";

$aSeq = $oConnection->queryTab($seq);

$url = Pelican::$config["DOCUMENT_HTTP"];

foreach ($aSeq as $seq) {
	$seq = str_replace("SEQ_","",$seq["SEQUENCE_NAME"]);
	if ($seq != 'LANGUAGE') {
		$sql = "select count(1) from user_tables where LOWER(TABLE_NAME)='".strtolower(Pelican::$config['FW_PREFIXE_TABLE'].$seq)."'";
		$num = $oConnection->queryItem($sql);
			sequence($seq);
		}
	}
echo "FIN";

function sequence($seq) {
	global $url, $oConnection;
	$max = $oConnection->queryItem("SELECT MAX(".$seq."_ID) from ".Pelican::$config['FW_PREFIXE_TABLE'].$seq);
	if (!$max) {
		$max = 1;
	}
	if ($max) {
		$sql1 = "DROP SEQUENCE SEQ_".$seq;
	$sql2 = "CREATE SEQUENCE SEQ_".$seq."
			START WITH ".($max+1)."
			MAXVALUE 999999999999999999999999999
			MINVALUE 1
			NOCYCLE
			NOCACHE
			NOORDER";
	$oConnection->query($sql1);
	echo($sql1);
	echo("<br>");
	$oConnection->query($sql2);
	echo($sql2);
	}
	echo("<br>");
	echo("<br>");
	flush();
}
?>