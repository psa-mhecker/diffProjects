<?php
/** Fichier de validation de la configuration matérielle
	*
	* @package Pelican
	* @subpackage config
	*/


/** Fichier de configuration */
include_once('config.php');

ini_set('display_errors', 1);
if (!Pelican::$config["SHOW_DEBUG"]) {
    exit();
}

/*Pelican::$config["DATABASE_TYPE"] = $LOCAL["DATABASE_TYPE"];
Pelican::$config["DATABASE_HOST"] = $LOCAL["DATABASE_HOST"];
Pelican::$config["DATABASE_PORT"] = $LOCAL["DATABASE_PORT"];
Pelican::$config["DATABASE_NAME"] = $LOCAL["DATABASE_NAME"];
Pelican::$config["DATABASE_USER"] = $LOCAL["DATABASE_USER"];
Pelican::$config["DATABASE_PASS"] = $LOCAL["DATABASE_PASS"];*/

/** Gestion des mails */
include_once(pelican_path('External.Simplemail'));
$media = (substr_count($_SERVER["HTTP_HOST"],"media"));
$bo = (substr_count($_SERVER["HTTP_HOST"],"backoffice") || substr_count($_SERVER["HTTP_HOST"],"back") || substr_count($_SERVER["HTTP_HOST"],"admin"));
$db = (Pelican::$config["SECOURS"]?"Accès de secours":(Pelican::$config["READ_ONLY"]?"Accès en Lecture Seule":""));

?>
<html>
<head>
<style>
.libelle {
	border: 1px outset window;
	margin: 0px;
	padding: 0px;
	width: 100%;
	text-align: center;
	font-weight: bold;
	color: Red;
	background-color: ActiveBorder;
}
.erreur {
	font-weight: bold;
	color: Red;
}
</style>
</head>
<body>
<?php
$hostname = ($_ENV["HOSTNAME"]?$_ENV["HOSTNAME"]:$_SERVER["HOSTNAME"]);
echo("<center><h2>Machine : ".$hostname."</h2></center>");

$Total = "OK_COMPLET";
if (!$_GET["top"]) {
	if (!$_SERVER['WINDIR']) {
		if (isset($hostname)) {
			$val = "OK";
		} else {
			$val = "KO";
			$Total = "KO";
		}
		showTest("Accès à la variable d'environnement 'hostname'", $val);
	}
	
	/****************************************************/
	if (isset(Pelican::$config["DATABASE_NAME"])) {
		$val = "OK";
	} else {
		$val = "KO";
		$Total = "KO";
	}
	showTest("Paramétrage de l'include path de le httpd.conf ('/application/configs')", $val);
	echo("<br>");
	/****************************************************/
	echo "<br><br><br><span class='libelle'>Connection à la base</span><br />";

	$oConnection = Pelican_Db::getInstance();
	if ($oConnection) {
		$val = "OK";
	} else {
		$val = "KO";
		$Total = "KO";
	}
	if ($val) {
		echo ($val == "OK"?"OK":"<span class='erreur'><b>KO</b></span>");
	}

	/****************************************************/
	if (@is_dir(Pelican::$config["CACHE_FW_ROOT"])) {
		$tmp = @sprintf("%o", (fileperms(Pelican::$config["CACHE_FW_ROOT"])) & 0755);
		$val = ($tmp == "755"?"OK":"KO");
		if ($tmp != "755") $Total = "KO";
		showTest("Droits sur le répertoire de ".Pelican::$config["CACHE_FW_ROOT"], $val);
	} else {
		showTest("Le répertoire de ".Pelican::$config["CACHE_FW_ROOT"]." n'existe pas", "KO");
	}


	if (!$media && !$bo) {
		/****************************************************/
		if (@is_dir(Pelican::$config["VAR_VIEW_COMPILES_ROOT"])) {
			$tmp = @sprintf("%o", (fileperms(Pelican::$config["VAR_VIEW_COMPILES_ROOT"])) & 0755);
			$val = ($tmp == "755"?"OK":"KO");
			if ($tmp != "755") $Total = "KO";
			showTest("Droits d'écriture sur le répertoire de ".Pelican::$config["VAR_VIEW_COMPILES_ROOT"], $val);
		} else {
			showTest("Le répertoire de ".Pelican::$config["VAR_VIEW_COMPILES_ROOT"]." n'existe pas", "KO");
		}

		/****************************************************/
		if (@is_dir(Pelican::$config["VAR_CACHE_VIEWS"])) {
			$tmp = @sprintf("%o", (fileperms(Pelican::$config["VAR_CACHE_VIEWS"])) & 0755);
			$val = ($tmp == "755"?"OK":"KO");
			if ($tmp != "755") $Total = "KO";
			showTest("Droits d'écriture sur le répertoire de Pelican_Cache de ".Pelican::$config["VAR_CACHE_VIEWS"], $val);
		} else {
			showTest("Le répertoire de Pelican_Cache de ".Pelican::$config["VAR_CACHE_VIEWS"]." n'existe pas", "KO");
		}
	}

	/****************************************************/
	if (@is_dir(Pelican::$config["MEDIA_ROOT"])) {
		$tmp = @sprintf("%o", (fileperms(Pelican::$config["MEDIA_ROOT"])) & 0755);
		$val = ($tmp == "755"?"OK":"KO");
		if ($tmp != "755") $Total = "KO";
		showTest("Droits d'écriture sur le répertoire de ".Pelican::$config["MEDIA_ROOT"], $val);
	} else {
		showTest("Le répertoire de Pelican_Cache de ".Pelican::$config["MEDIA_ROOT"]." n'existe pas", "KO");
	}

	/****************************************************/
	@unlink(Pelican::$config["CACHE_FW_ROOT"]."/text_a2e1706211d348e33eb4a44b45603165.jpg");

	showTest("Texte en image");
	echo "<img src=\"".Pelican::$config["MEDIA_HTTP"].Pelican::$config["MEDIA_LIB_PATH"]."/image_title.php?text=".rawurlencode("GENERATION D'IMAGE TEST")."&size=3&preview=1\">";

	/****************************************************/
	@unlink(Pelican::$config["CACHE_FW_ROOT"]."/text_54f76884ac56ebd592c3b6afbbf50664.jpg");

	showTest("Texte en image sur le 404");
	echo "<img src=\"".Pelican::$config["MEDIA_HTTP"]."/text/3/".rawurlencode("GENERATION D'IMAGE TEST SUR LE 404")."\">";

	/****************************************************/
	if (file_exists(Pelican::$config["MEDIA_ROOT"]."/image/00/1/1.gif")) {
		$path = "/image/00/1/1.gif";
	}

@unlink(Pelican::$config["CACHE_FW_ROOT"]."/2d31/2d32/mediabuild_2d31353439353832393830_2d32303832363732373133.jpg");
@unlink(Pelican::$config["CACHE_FW_ROOT"]."/2d31/3435/mediabuild_2d31353439353832393830_343530323135343337.jpg");
@unlink(Pelican::$config["CACHE_FW_ROOT"]."/2d31/2d38/mediabuild_2d31353439353832393830_2d383137383134343734.jpg");

	$path0 = Pelican::$config["MEDIA_LIB_PATH"]."/image_format.php?path=".$path."&format=1";
	showTest("Image redimensionnée : ".$path0);
	echo "<img src=\"".Pelican::$config["MEDIA_HTTP"].$path0."\">";

	/****************************************************/
	$path0 = str_replace(".gif", ".2.gif", $path);
	showTest("Image redimensionnée sur le 404 : ".$path0);
	echo "<img src=\"".Pelican::$config["MEDIA_HTTP"].$path0."\">";

	/****************************************************/
	$path0 = Pelican::$config["MEDIA_LIB_PATH"]."/image_format.php?path=".$path."&format=1&crop=192,0,388,292";
	showTest("Image recadrée et redimensionnée : ".$path0);
	echo "<img src=\"".Pelican::$config["MEDIA_HTTP"].$path0."&preview=1\">";

	/****************************************************/
	$cmd = Pelican::$config["IM_ROOT"]." -antialias -quality 100 -crop 200x400+0+0 -geometry 200x400 ".Pelican::$config["MEDIA_ROOT"]."/image/etalon.gif ".Pelican::$config["MEDIA_ROOT"]."/image/validation.gif";
	Pelican::runCommand($cmd);
	showTest("Installation d'Image Magick");
	echo "<img src=\"".Pelican::$config["MEDIA_HTTP"]."/image/validation.gif\">";
	
	/****************************************************/
	/*if (function_exists("eaccelerator")) {
		ob_start();
		@eaccelerator();
		$return = ob_get_contents();
		ob_end_clean();
		ob_flush();
		$nb = @strlen($return);
	} else {
		$nb = 0;
	}
	if ($nb > 45) {
		$val = "OK";
	} else {
		$val = "KO";
		$Total = "KO";
	}
	showTest("Installation d'eaccelerator", $val);*/

	echo("<br><br><br>");
	echo $Total;
} else {
	exec("top", $top, $error);
	debug(array("retour" => $top, "erreur" => $error), $hostname);
}

function showTest($label, $state = "") {
	echo "<br><br><br><span class='libelle'>".$label."</span><br />";
	if ($state) {
		echo ($state == "OK"?"OK":"<span class='erreur'><b>KO</b></span>");
	}
}
?>