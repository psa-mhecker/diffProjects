<?php
include_once('config.php');

set_time_limit(3000);

require_once(pelican_path('Exploit.Reprise'));
require_once(pelican_path('Media'));
pelican_import('Index.Backoffice.Process');
require_once(pelican_path('Media'));
if (!Pelican::$config["SHOW_DEBUG"]) {
    exit();
}
recupZone();

function recupZone() {
	

	$oConnection = Pelican_Db::getInstance();
	$oConnection->setExitOnError(false);

	include(pelican_path('Html.Tidy'));

	$options['quiet'] = '1';
	$options['force-output'] = '1';
	$options['show-warnings'] = 'false';
	$options['drop-proprietary-attributes'] = '1';
	$options['show-body-only'] = '1';
	$options['word-2000'] = '1';
	$options['indent'] = '0';
	$options['indent-attributes'] = '0';
	$options['indent-spaces'] = '0';
	$options['wrap'] = '0';
	$options['wrap-attributes'] = '0';
	$options['drop-proprietary-attributes'] = '0';
	$options['output-xhtml'] = '1';
	$options['accessibility-check'] = '0';
	$options['bare'] = '1';
	$options['enclose-block-text'] = '0';
	$options['enclose-text'] = '0';
	$options['fix-backslash'] = '1';
	$options['logical-emphasis'] = '1';
	$options['hide-comments'] = '1';

	$sql = "select a.CONTENT_ID, a.CONTENT_VERSION2, b.* from
	(select CONTENT_ID, CONTENT_DRAFT_VERSION as CONTENT_VERSION2 from men_content
	UNION
	select CONTENT_ID, CONTENT_CURRENT_VERSION as CONTENT_VERSION2 from men_content) a
	inner join ATG_content_zone b on (a.content_id=b.content_id)";
	$result = $oConnection->queryTab($sql);

	Pelican_Exploit_Reprise::showMsg("Nombres de contenus : ".count($result));

	//$oConnection->query("TRUNCATE TABLE MEN_CONTENT_ZONE");
	if ($result) {
		foreach ($result as Pelican_Db::$values) {
				Pelican_Db::$values["CONTENT_VERSION"] = Pelican_Db::$values["CONTENT_VERSION2"];
				if (Pelican_Db::$values["CONTENT_ZONE_TEXT"]) {
					$tidy = new Pelican_Html_Tidy($options);
					$tidy->clean(Pelican_Db::$values["CONTENT_ZONE_TEXT"]);
					Pelican_Db::$values["CONTENT_ZONE_TEXT"] = $tidy->html;
				}
				Pelican_Exploit_Reprise::showMsg("Id : ".Pelican_Db::$values["CONTENT_ID"]." ".Pelican_Db::$values["CONTENT_VERSION"]." ".Pelican_Db::$values["CONTENT_ZONE_ID"]);
				$oConnection->deleteQuery("MEN_CONTENT_ZONE");
				$oConnection->insertQuery("MEN_CONTENT_ZONE");
		}
	}
}

?>