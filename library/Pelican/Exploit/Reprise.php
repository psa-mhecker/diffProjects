<?php
class Pelican_Exploit_Reprise {

	function Pelican_Exploit_Reprise($label, $process) {
		$this->label = $label;
		$this->process = $process;

		$this->begin();
		call_user_func($this->process);
		$this->end();
	}

	function begin() {
		echo "<div style=\"border : thin solid Black;\"><h1>".$this->label."</h1><br /><ul>";
		flush();
	}

	function end() {
		echo "</ul></div>";
		flush();
	}

	function showMsg($msg) {
		echo Pelican_Html::li($msg);
		flush();
	}

	function page_path() {
		
		pelican_import('Hierarchy');

		$oConnection = Pelican_Db::getInstance();

		/** page path */
		$sql = "select p.PAGE_ID \"id\", ".$oConnection->getConcatClause(array("p.PAGE_ID","'|'","PAGE_TITLE_BO"))." \"lib\", PAGE_PARENT_ID \"pid\", (page_order+p.page_id/10000) \"ordre\",p.LANGUE_ID from #pref#_page p
	INNER JOIN #pref#_page_version pv on (p.PAGE_ID = pv.PAGE_ID AND p.PAGE_CURRENT_VERSION = pv.PAGE_VERSION AND p.LANGUE_ID = pv.LANGUE_ID)
	order by page_order";

		$page = $oConnection->queryTab($sql);

		Pelican_Exploit_Reprise::showMsg("Nombre de pages : ".count($page));

		$sql = "update #pref#_page set PAGE_ORDER=:PAGE_ORDER, PAGE_PATH=:PAGE_PATH, PAGE_LIBPATH=:PAGE_LIBPATH
	where PAGE_ID=:PAGE_ID and LANGUE_ID=:LANGUE_ID";
		$oHierarchie = Pelican_Factory::getInstance('Hierarchy',1, "id", "pid");
		$oHierarchie->addTabNode($page);
		$oHierarchie->setOrder("ordre", "ASC");
		foreach ($oHierarchie->aNodes as $node) {
			//debug($node->id);
			$aBind[":LANGUE_ID"] = $node->ordre;
			$aBind[":PAGE_ORDER"] = $node->ordre;
			$aBind[":PAGE_ID"] = $node->id;
			$aBind[":PAGE_PATH"] = $oConnection->strToBind(str_replace(" # ","#", $oHierarchie->getNodePath($node->id, "id", "#")));
			$aBind[":PAGE_LIBPATH"] = $oConnection->strToBind(str_replace(" # ","#", $oHierarchie->getNodePath($node->id, "lib", "#")));
			$oConnection->query($sql, $aBind);
			Pelican_Exploit_Reprise::showMsg("id, Langue : (".$node->id.", ".$node->LANGUE_ID.") => ".$aBind[":PAGE_PATH"]." / ".$aBind[":PAGE_LIBPATH"]);
		}
	}

	function clear_url() {
		

		$sql = "select cv.CONTENT_ID, CONTENT_TITLE_BO, cv.CONTENT_VERSION, PAGE_ID, LANGUE_ID from #pref#_content_version cv";

		Pelican_Exploit_Reprise::showMsg(Pelican_Html::b("Contenus"));
		Pelican_Exploit_Reprise::_clear_url($sql, "cid", "content");

		Pelican_Exploit_Reprise::showMsg(Pelican_Html::b("Pages"));
		$sql = "select p.PAGE_ID, PAGE_TITLE_BO, PAGE_VERSION, PAGE_PATH, PAGE_LIBPATH, p.LANGUE_ID from #pref#_page_version pv
		inner join #pref#_page p on (p.page_id=pv.page_id and PAGE_CURRENT_VERSION=PAGE_VERSION and p.LANGUE_ID=pv.LANGUE_ID) ";
		Pelican_Exploit_Reprise::_clear_url($sql, "pid", "page");

	}

	function _clear_url($sql, $type, $table) {
		

		$oConnection = Pelican_Db::getInstance();

		$result = $oConnection->queryTab($sql);
		Pelican_Exploit_Reprise::showMsg("Nombre : ".count($result));
		if ($result) {
			foreach($result as $line) {
				$aBind[":LANGUE_ID"] = $line[strtoupper('LANGUE_ID')];
				$aBind[":ID"] = $line[strtoupper($table."_ID")];
				$aBind[":VERSION"] = $line[strtoupper($table."_VERSION")];
				$aBind[":TITLE_BO"] = $line[strtoupper($table."_TITLE_BO")];
				$aBind[":PAGE_ID"] = $line["PAGE_ID"];
				if ($table=="content" && $line["PAGE_ID"] && !$line["PAGE_LIBPATH"]) {
					$line["PAGE_LIBPATH"] = $oConnection->queryItem("select PAGE_LIBPATH from
					#pref#_page p WHERE p.PAGE_ID=".$line["PAGE_ID"]." AND LANGUE_ID=".$line['LANGUE_ID']);
				}
				$aBind[":CLEAR_URL"] = $oConnection->strToBind(makeClearUrl($aBind[":ID"], $type, $aBind[":TITLE_BO"], $line["PAGE_LIBPATH"]));
				Pelican_Exploit_Reprise::showMsg("id, Langue, Version : (".$aBind[":ID"].", ".$aBind[":LANGUE_ID"].", ".$aBind[":VERSION"].") => ".$aBind[":CLEAR_URL"]);
				if ($table == "content") {
					$sql = "update #pref#_content_version set ".$table."_CLEAR_URL=:CLEAR_URL where
					".$table."_ID = :ID
					and ".$table."_VERSION=:VERSION 
					and PAGE_ID=:PAGE_ID 
					and LANGUE_ID=:LANGUE_ID";
				} else {
					$sql = "update ".Pelican::$config['FW_PREFIXE_TABLE'].$table."_version set ".$table."_CLEAR_URL=:CLEAR_URL where
					".$table."_ID = :ID
					and ".$table."_VERSION=:VERSION
					and LANGUE_ID=:LANGUE_ID";
				}
				$oConnection->query($sql, $aBind);
			}
		}
	}

	function xiti() {
		

		$oConnection = Pelican_Db::getInstance();
		$oConnection->setExitOnError(false);

		$oConnection->query("truncate table #pref#_tag");

		$sql = "select #pref#_page.page_id, page_path, #pref#_page.SITE_ID, page_libpath, PAGE_TITLE_BO from #pref#_page
	inner join #pref#_page_version on (#pref#_page.page_id=#pref#_page_version.page_id and #pref#_page.page_current_version=#pref#_page_version.page_version)";
		$aPath = $oConnection->queryTab($sql);
		Pelican_Exploit_Reprise::showMsg("Nombre de pages : ".count($aPath));

		if ($aPath) {
			foreach($aPath as $path) {
				$temp = Pelican_Text::cleanText(str_replace("1|","",preg_replace("/(\#([0-9]+)\|)/si","xxxx",$path["PAGE_LIBPATH"])),"_");
				$chemin[$path["PAGE_ID"]] = str_replace("xxxx","::",$temp);
				Pelican_Db::$values["TAG_ID"] = "pid=".$path["PAGE_ID"];
				Pelican_Db::$values["TAG_SECTION"] = 'page';
				Pelican_Db::$values["TAG_RUBRIQUE"] = $chemin[$path["PAGE_ID"]];
				Pelican_Db::$values["TAG_PID"] = $path["PAGE_ID"];
				Pelican_Db::$values['SITE_ID'] = $path['SITE_ID'];
				Pelican_Db::$values["TAG_LABEL"] = $path["PAGE_TITLE_BO"];
				Pelican_Db::$values["TAG_RUBRIQUE"] = str_replace("-","_",Pelican_Db::$values["TAG_RUBRIQUE"]);
				if (Pelican_Db::$values["TAG_RUBRIQUE"] != "page_d_accueil") {
					Pelican_Db::$values["TAG_RUBRIQUE"] = str_replace("page_d_accueil::","",Pelican_Db::$values["TAG_RUBRIQUE"]);
				}
				$oConnection->deleteQuery("#pref#_tag");
				$oConnection->insertQuery("#pref#_tag");
				$oConnection->commit();
				Pelican_Exploit_Reprise::showMsg("pid ".$path["PAGE_ID"]." => ".$section." : ".Pelican_Db::$values["TAG_RUBRIQUE"]);
			}
		}
		//debug($chemin);

		$sql = "select page_id, #pref#_content.content_id, #pref#_content.SITE_ID,content_title_bo from #pref#_content_version
	inner join #pref#_content on (#pref#_content.content_id=#pref#_content_version.content_id and #pref#_content.content_current_version=#pref#_content_version.content_version)";
		$aContent = $oConnection->queryTab($sql);

		$sqlsection = "select TAG_PID, TAG_SECTION from #pref#_tag where TAG_PID is not null and TAG_CID is null";
		$resultSection = $oConnection->queryTab($sqlsection);
		if ($resultSection) {
			foreach ($resultSection as $values) {
				$aSection[$values["TAG_PID"]] = $values["TAG_SECTION"];
			}
		}
		if ($aContent) {
			foreach($aContent as $content) {
				Pelican_Db::$values["TAG_ID"] = "cid=".$content["CONTENT_ID"];
				Pelican_Db::$values["TAG_SECTION"] = 'contenu';
				Pelican_Db::$values["TAG_RUBRIQUE"] = str_replace("xxxx","::",Pelican_Text::cleanText(str_replace("::","xxxx",$chemin[$content["PAGE_ID"]])."xxxx".$content["CONTENT_TITLE_BO"],"_"));
				Pelican_Db::$values["TAG_RUBRIQUE"] = str_replace("page_d_accueil::","",Pelican_Db::$values["TAG_RUBRIQUE"]);
				Pelican_Db::$values["TAG_CID"] = $content["CONTENT_ID"];
				Pelican_Db::$values['SITE_ID'] = $content['SITE_ID'];
				Pelican_Db::$values["TAG_LABEL"] = $content["CONTENT_TITLE_BO"];
				$oConnection->deleteQuery("#pref#_tag");
				$oConnection->insertQuery("#pref#_tag");
				$oConnection->commit();
				Pelican_Exploit_Reprise::showMsg("cid ".$content["CONTENT_ID"]." => ".Pelican_Db::$values["TAG_SECTION"]." : ".Pelican_Db::$values["TAG_RUBRIQUE"]);
			}
		}

		Pelican_Exploit_Reprise::showMsg("Nombre de contenus : ".count($aContent));
	}
}
?>